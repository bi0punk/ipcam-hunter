version: "3.8"

services:
  waha:
    image: devlikeapro/waha
    container_name: waha
    ports:
      - "3000:3000"
    env_file:
      - .env
    environment:
      - WAHA_API_KEY=${WAHA_API_KEY}
    volumes:
      - ./waha-sessions:/app/.sessions
    restart: unless-stopped

  roi-alert:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: roi-alert
    depends_on:
      - waha
    env_file:
      - .env
    environment:
      - WAHA_API_KEY=${WAHA_API_KEY}
      - CONFIG_PATH=/app/config.yaml
      - EVENTS_DIR=/data/events
      # opcionales (si quieres separar streams):
      # - CAM_RTSP_URL_SUB=${CAM_RTSP_URL_SUB}
      # - CAM_RTSP_URL_MAIN=${CAM_RTSP_URL_MAIN}
    volumes:
      - ./app/config.yaml:/app/config.yaml:ro
      - ./events:/data/events
      - ./cache:/root/.cache
      - ./ultralytics:/root/.config/Ultralytics
    restart: unless-stopped

  dashboard:
    build:
      context: .
      dockerfile: dashboard/Dockerfile
    container_name: roi-dashboard
    depends_on:
      - roi-alert
    env_file:
      - .env
    environment:
      - PORT=8081
      - EVENTS_DIR=/data/events
      - OVERLAY_JSON=/data/events/overlay.json
      - STATUS_JSON=/data/events/status.json

      # Video preview: idealmente substream para m√°xima fluidez/CPU bajo
      # Si no defines CAM_RTSP_URL_PREVIEW, usa CAM_RTSP_URL.
      - CAM_RTSP_URL_PREVIEW=${CAM_RTSP_URL_PREVIEW}

      # Opcional: control del preview
      - PREVIEW_WIDTH=640
      - PREVIEW_FPS=15
      - JPEG_QUALITY=80
    ports:
      - "8081:8081"
    volumes:
      - ./events:/data/events:ro
    restart: unless-stopped